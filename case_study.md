# Case-study оптимизации импорта данных в БД

## Актуальная проблема
Текущая задача веб-приложения - отображение автобусных рейсов. Данные для отображения берутся из
базы данных. В базу данных они попадают с помощью `rake task'a` `:reload_json`, находящегося в
`utlis.rake`. Данный таск импортирует данные из `json` файла, передаваемого ему в качестве 
параметра, в базу данных.  
При больших объемах данных таск работает слишком медленно, в связи с чем было принято решение его
оптимизировать.

## Формирование метрики
За метрикой было взято время импорта в базу данных. Для ее приблизительного формирования был 
использован метод `Time::now`. Файл `medium.json`, содержащий 10_000 записей импортируется в базу
данных за 60.388 секунд. В качестве бюджета метрики было задано время ипорта в базу данных в 60
секунд для файла `large.json`, содержащего 100_000 записей.

## Гарантия работы оптимизированной программы
Для гарантии работы оптимизированной программы было решено покрыть данный `rake task` тестами с
использованием библиотеки `rspec`.

## Feedback-Loop
Для эффективной оптимизации был выстроен следующий `feedback-loop`: Профилирование с использованием
`ruby-prof` и `pghero`-> Оптимизация -> Проверка работы программы с использованием тестов -> 
Закрепление результатов оптимизации с помощью тестов, написанных с использованием библиотеки 
`rspec-benchmark`.

## Анализ ассимптотики
Для анализа ассимптотики файл `small.json`, содержащий 10_000 записей был поделен на небольшие
файлы, содержащие 1000, 2000, 3000, 4000 и 5000 записей. В результате сбора метрики была выявлена 
следующая ассиптотика:  
1 1000 строк - 7.847 секунды  
2 2000 строк - 13.851 секунд  
3 3000 строк - 19.965 секунд  
4 4000 строк - 26.765 секунд  
5 5000 строк - 31.808 секунд  
Исходя из данного анализа был сделан вывод, что ассимптотика меньше линейной. Однако с такой 
ассимптотикой в поставленный бюджет не уложиться.

## Анализ точек роста
Для анализа основных точек роста был взят сэмпл файл на 300 строк, `300.json`, так как с ним фидбек 
луп занимает меньше 3-х секунд. Так как не было написано тестов, проверяющих функционал данного 
`rake task`'a, было решено начать с написания тестов.